apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: run-iqe-cji
spec:
  params:
    - name: BONFIRE_IMAGE
      type: string
      description: The container Bonfire image to use for the tekton tasks
      default: quay.io/redhat-services-prod/hcm-eng-prod-tenant/cicd-tools:d9a3964
    - name: EPHEMERAL_ENV_PROVIDER_SECRET
      type: string
      default: ephemeral-env-provider
    - name: NS
      type: string
      description: Namespace name to deploy the application to
    - name: NS_REQUESTER
      type: string
      description: The name of the person/pipeline that requested the namespace
    - name: COMPONENT_NAME
      type: string
      description: name of app-sre "resourceTemplate" in deploy.yaml for this component
    - name: BONFIRE_COMPONENT_NAME
      type: string
      description: name of the app-sre component name
      default: ""
    - name: IQE_PLUGINS
      type: string
      description: name of the IQE plugin for this app.
    - name: IQE_MARKER_EXPRESSION
      type: string
      description: This is the value passed to pytest -m
      default: ""
    - name: IQE_FILTER_EXPRESSION
      type: string
      description: This is the value passed to pytest -k
      default: test_plugin_accessible
    - name: IQE_REQUIREMENTS
      type: string
      description: ""
      default: ""
    - name: IQE_REQUIREMENTS_PRIORITY
      type: string
      description: ""
      default: ""
    - name: IQE_TEST_IMPORTANCE
      type: string
      description: ""
      default: ""
    - name: IQE_CJI_TIMEOUT
      type: string
      description: This is the time to wait for smoke test to complete or fail
      default: 30m
    - name: IQE_ENV
      type: string
      description: "something -- value to set for ENV_FOR_DYNACONF, default is \"clowder_smoke\""
      default: "clowder_smoke"
    - name: IQE_ENV_VARS
      type: string
      description: "Comma delimited string with additional values, such as IQE_ENV_VARS='DYNACONF_USER_PROVIDER__rbac_enabled=false,foo=bar'"
      default: ""
    - name: IQE_SELENIUM
      type: string
      description: "true -- whether to run IQE pod with a selenium container, default is false"
      default: "false"
    - name: IQE_PARALLEL_ENABLED
      type: string
      description: "whether to run IQE with --parallel-enabled"
      default: "false"
    - name: IQE_PARALLEL_WORKER_COUNT
      type: string
      description: "Number of parallel workers to use"
      default: ""
    - name: IQE_RP_ARGS
      type: string
      description: "Arguments to send to reportportal"
      default: ""
    - name: IBUTSU_SOURCE
      type: string
      description: "Update the ibutsu source for the current run"
      default: ""
    - name: IBUTSU_MODE
      type: string
      description: "Update the ibutsu mode for the current run"
      default: "archive"
    - name: IQE_IMAGE_TAG
      type: string
      description: "Tag of the IQE image to be used"
      default: ""
    - name: USE_LOCAL_PLUGIN
      type: string
      description: "Set to 'true' to install IQE plugin from the component's source repository"
      default: "false"
    - name: LOCAL_PLUGIN_FOLDER
      type: string
      description: "Folder within the component repository containing the IQE plugin (e.g., 'iqe-plugin')"
      default: ""
  workspaces:
    - name: source
      description: Source code of the component being tested (optional, required when USE_LOCAL_PLUGIN is true)
      optional: true
  steps:
    - name: deploy-iqe-cji
      image: "$(params.BONFIRE_IMAGE)"
      workingDir: /workspace
      env:
        - name: OC_LOGIN_TOKEN
          valueFrom:
            secretKeyRef:
              name: $(params.EPHEMERAL_ENV_PROVIDER_SECRET)
              key: token
        - name: OC_LOGIN_SERVER
          valueFrom:
            secretKeyRef:
              name: $(params.EPHEMERAL_ENV_PROVIDER_SECRET)
              key: url
        - name: COMPONENT_NAME
          value: $(params.COMPONENT_NAME)
        - name: BONFIRE_COMPONENT_NAME
          value: $(params.BONFIRE_COMPONENT_NAME)
        - name: IQE_PLUGINS
          value: $(params.IQE_PLUGINS)
        - name: IQE_MARKER_EXPRESSION
          value: $(params.IQE_MARKER_EXPRESSION)
        - name: IQE_FILTER_EXPRESSION
          value: $(params.IQE_FILTER_EXPRESSION)
        - name: IQE_REQUIREMENTS
          value: $(params.IQE_REQUIREMENTS)
        - name: IQE_REQUIREMENTS_PRIORITY
          value: $(params.IQE_REQUIREMENTS_PRIORITY)
        - name: IQE_TEST_IMPORTANCE
          value: $(params.IQE_TEST_IMPORTANCE)
        - name: IQE_CJI_TIMEOUT
          value: $(params.IQE_CJI_TIMEOUT)
        - name: IQE_ENV
          value: $(params.IQE_ENV)
        - name: IQE_ENV_VARS
          value: $(params.IQE_ENV_VARS)
        - name: IQE_SELENIUM
          value: $(params.IQE_SELENIUM)
        - name: IQE_PARALLEL_ENABLED
          value: $(params.IQE_PARALLEL_ENABLED)
        - name: IQE_PARALLEL_WORKER_COUNT
          value: $(params.IQE_PARALLEL_WORKER_COUNT)
        - name: IQE_RP_ARGS
          value: $(params.IQE_RP_ARGS)
        - name: IBUTSU_SOURCE
          value: $(params.IBUTSU_SOURCE)
        - name: IBUTSU_MODE
          value: $(params.IBUTSU_MODE)
        - name: BONFIRE_BOT
          value: "true"
        - name: IQE_IMAGE_TAG
          value: $(params.IQE_IMAGE_TAG)
        - name: USE_LOCAL_PLUGIN
          value: $(params.USE_LOCAL_PLUGIN)
        - name: LOCAL_PLUGIN_FOLDER
          value: $(params.LOCAL_PLUGIN_FOLDER)
      script: |
        #!/bin/bash
        set -ex

        echo "Connecting to the ephemeral namespace cluster"
        login.sh

        if [ "$USE_LOCAL_PLUGIN" = "true" ]; then
          echo "========================================================"
          echo "Running CJI tests with local IQE plugin"
          echo "========================================================"

          if [ -z "$LOCAL_PLUGIN_FOLDER" ]; then
            echo "ERROR: LOCAL_PLUGIN_FOLDER must be set when USE_LOCAL_PLUGIN is true"
            exit 1
          fi

          PLUGIN_SOURCE_PATH="/workspace/source/$LOCAL_PLUGIN_FOLDER"
          if [ ! -d "$PLUGIN_SOURCE_PATH" ]; then
            echo "ERROR: Plugin folder not found at $PLUGIN_SOURCE_PATH"
            exit 1
          fi

          echo "Deploying CJI pod with --debug-pod option..."
          # Deploy the CJI pod with --debug-pod to prevent auto-execution
          POD=$(bonfire deploy-iqe-cji $COMPONENT_NAME \
              --debug-pod \
              ${IQE_MARKER_EXPRESSION:+--marker "$IQE_MARKER_EXPRESSION"} \
              ${IQE_FILTER_EXPRESSION:+--filter "$IQE_FILTER_EXPRESSION"} \
              --env "$IQE_ENV" \
              --cji-name "iqe-local-${COMPONENT_NAME}" \
              ${IQE_PLUGINS:+--plugins "$IQE_PLUGINS"} \
              ${IQE_IMAGE_TAG:+--image-tag "$IQE_IMAGE_TAG"} \
              ${IQE_REQUIREMENTS:+--requirements "$IQE_REQUIREMENTS"} \
              ${IQE_REQUIREMENTS_PRIORITY:+--requirements-priority "$IQE_REQUIREMENTS_PRIORITY"} \
              ${IQE_TEST_IMPORTANCE:+--test-importance "$IQE_TEST_IMPORTANCE"} \
              ${IQE_ENV_VARS:+--env-vars "$IQE_ENV_VARS"} \
              ${IQE_SELENIUM:+--selenium "$IQE_SELENIUM"} \
              ${IQE_PARALLEL_ENABLED:+--parallel-enabled "$IQE_PARALLEL_ENABLED"} \
              ${IQE_PARALLEL_WORKER_COUNT:+--parallel-worker-count "$IQE_PARALLEL_WORKER_COUNT"} \
              ${IQE_RP_ARGS:+--rp-args "$IQE_RP_ARGS"} \
              ${IBUTSU_SOURCE:+--ibutsu-source "$IBUTSU_SOURCE"} \
              -n "$(params.NS)" 2>&1 | grep -oP '(?<=Pod name: ).*' || echo "")

          if [ -z "$POD" ]; then
            echo "ERROR: Failed to get POD name from bonfire deploy-iqe-cji command"
            echo "Trying alternative method to find the pod..."
            sleep 5
            POD=$(oc get pods -n $(params.NS) -l job-name --sort-by=.metadata.creationTimestamp -o jsonpath='{.items[-1:].metadata.name}')

            if [ -z "$POD" ]; then
              echo "ERROR: Still could not find the pod"
              exit 1
            fi
          fi

          echo "CJI Pod: $POD"

          # Wait for the pod to be ready
          echo "Waiting for pod to be ready..."
          oc wait --for=condition=Ready pod/$POD -n $(params.NS) --timeout=300s || {
            echo "WARNING: Pod did not become ready in time, but continuing..."
          }

          # Give the pod a moment to fully initialize
          sleep 10

          echo "Installing setuptools_scm..."
          oc exec -n $(params.NS) $POD -- pip install -i https://pypi.python.org/simple setuptools_scm || {
            echo "WARNING: Failed to install setuptools_scm, continuing anyway..."
          }

          echo "Copying local IQE plugin to pod..."
          echo "Source: $PLUGIN_SOURCE_PATH"

          # Copy the local plugin directory to the pod
          oc cp -n $(params.NS) "$PLUGIN_SOURCE_PATH" "$POD:iqe-local-plugin"

          # Create a minimal git repository so setuptools-scm can detect a version
          echo "Initializing git repo for version detection..."
          oc exec -n $(params.NS) $POD -- bash -c "cd iqe-local-plugin && git init && git config user.email 'ci@redhat.com' && git config user.name 'CI' && git add -A && git commit -m 'local' && git tag v999.0.0"

          echo "Installing local IQE plugin in the pod..."
          oc exec -n $(params.NS) $POD -- bash -c "cd iqe-local-plugin && pip install -i https://pypi.python.org/simple -e ."

          echo "Verifying plugin installation..."
          oc exec -n $(params.NS) $POD -- iqe plugin list | grep -i "$IQE_PLUGINS" || {
            echo "WARNING: Could not verify plugin installation"
          }

          echo "========================================================"
          echo "Running tests with local plugin..."
          echo "========================================================"

          # Build the IQE test command
          IQE_CMD="iqe tests plugin $IQE_PLUGINS"
          if [ -n "$IQE_MARKER_EXPRESSION" ]; then
            IQE_CMD="$IQE_CMD -m \"$IQE_MARKER_EXPRESSION\""
          fi
          if [ -n "$IQE_FILTER_EXPRESSION" ]; then
            IQE_CMD="$IQE_CMD -k \"$IQE_FILTER_EXPRESSION\""
          fi
          IQE_CMD="$IQE_CMD --junitxml=/iqe_venv/iqe-junit-report.xml -o junit_suite_name=iqe"

          echo "Running: $IQE_CMD"

          # Run tests in the pod
          set +e
          oc exec -n $(params.NS) $POD -- bash -c "$IQE_CMD"
          TEST_EXIT_CODE=$?
          set -e

          if [ $TEST_EXIT_CODE -eq 0 ]; then
            echo "========================================================"
            echo "Tests PASSED"
            echo "========================================================"
          else
            echo "========================================================"
            echo "Tests FAILED with exit code: $TEST_EXIT_CODE"
            echo "========================================================"
          fi

          # The bonfire command would normally handle cleanup and reporting
          # For now, we'll exit with the test exit code
          exit $TEST_EXIT_CODE
        else
          echo "Deploying the IQE CJI test using standard approach"
          deploy-iqe-cji.sh "$(params.NS)" "$(params.NS_REQUESTER)"
        fi
